name: Windows Build

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-windows:
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        php-version: ["8.1", "8.2", "8.3", "8.4"]
        arch: ["x64"]
        ts: ["nts"]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build the extension
        uses: php/php-windows-builder/extension@v1
        with:
          php-version: ${{ matrix.php-version }}
          arch: ${{ matrix.arch }}
          ts: ${{ matrix.ts }}
          libs: libjudy

      - name: Debug build and test failures
        if: failure()
        shell: pwsh
        run: |
          $ErrorActionPreference = "Continue"

          Write-Host "=== File sizes ==="
          $phpJudy = Get-ChildItem -Path ".\build" -Recurse -Filter "php_judy.dll" -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($phpJudy) {
            Write-Host "php_judy.dll: $($phpJudy.FullName) ($($phpJudy.Length) bytes)"
          } else {
            Write-Host "php_judy.dll NOT FOUND"
          }
          $judyDll = Get-ChildItem -Path ".\build" -Recurse -Filter "Judy.dll" -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($judyDll) {
            Write-Host "Judy.dll: $($judyDll.FullName) ($($judyDll.Length) bytes)"
          } else {
            Write-Host "Judy.dll NOT FOUND in build tree"
          }
          $judyLib = Get-ChildItem -Path ".\build" -Recurse -Filter "libJudy.lib" -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($judyLib) {
            Write-Host "libJudy.lib: $($judyLib.FullName) ($($judyLib.Length) bytes)"
          }

          Write-Host "`n=== Deps directory contents ==="
          Get-ChildItem -Path ".\build\deps" -Recurse -ErrorAction SilentlyContinue | ForEach-Object {
            Write-Host "  $($_.FullName.Replace((Resolve-Path '.\build\deps').Path, ''))  ($($_.Length) bytes)"
          }

          Write-Host "`n=== PHP + extension diagnostics ==="
          $php = Get-ChildItem -Path ".\build" -Recurse -Filter "php.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
          $ext = Get-ChildItem -Path ".\build" -Recurse -Filter "php_judy.dll" -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($php -and $ext) {
            # Add deps\bin to PATH so Judy.dll is findable (if dynamically linked)
            $depsbin = ".\build\deps\bin"
            if (Test-Path $depsbin) {
              $env:PATH = (Resolve-Path $depsbin).Path + ";" + $env:PATH
              Write-Host "Added to PATH: $(Resolve-Path $depsbin)"
            }

            Write-Host "`n--- Test 0: phpinfo (judy section) ---"
            & $php.FullName -n -d "extension=$($ext.FullName)" --ri judy 2>&1
            Write-Host "Exit code: $LASTEXITCODE"

            Write-Host "`n--- Test 1: Extension loading ---"
            & $php.FullName -n -d "extension=$($ext.FullName)" -r "echo 'loaded: ' . (extension_loaded('judy') ? 'yes' : 'no') . PHP_EOL;" 2>&1
            Write-Host "Exit code: $LASTEXITCODE"

            Write-Host "`n--- Test 2: Object creation ---"
            & $php.FullName -n -d "extension=$($ext.FullName)" -r "echo 'BITSET=' . Judy::BITSET . PHP_EOL; `$j = new Judy(Judy::BITSET); echo 'created' . PHP_EOL;" 2>&1
            Write-Host "Exit code: $LASTEXITCODE"

            Write-Host "`n--- Test 3: Judy BITSET set single ---"
            & $php.FullName -n -d "extension=$($ext.FullName)" -r "`$j = new Judy(Judy::BITSET); `$j[0] = true; echo 'BITSET[0]=true OK' . PHP_EOL;" 2>&1
            Write-Host "Exit code: $LASTEXITCODE"

            Write-Host "`n--- Test 4: Judy BITSET set + test ---"
            & $php.FullName -n -d "extension=$($ext.FullName)" -r "`$j = new Judy(Judy::BITSET); `$j[0] = true; echo 'set OK' . PHP_EOL; var_dump(isset(`$j[0])); echo 'test OK' . PHP_EOL;" 2>&1
            Write-Host "Exit code: $LASTEXITCODE"

            Write-Host "`n--- Test 5: Judy BITSET count ---"
            & $php.FullName -n -d "extension=$($ext.FullName)" -r "`$j = new Judy(Judy::BITSET); `$j[0] = true; echo 'count=' . `$j->count() . PHP_EOL;" 2>&1
            Write-Host "Exit code: $LASTEXITCODE"

            Write-Host "`n--- Test 6: Judy INT_TO_INT set ---"
            & $php.FullName -n -d "extension=$($ext.FullName)" -r "`$j = new Judy(Judy::INT_TO_INT); `$j[0] = 42; echo 'INT_TO_INT set OK' . PHP_EOL;" 2>&1
            Write-Host "Exit code: $LASTEXITCODE"

            Write-Host "`n--- Test 7: Judy STRING_TO_INT set ---"
            & $php.FullName -n -d "extension=$($ext.FullName)" -r "`$j = new Judy(Judy::STRING_TO_INT); `$j['a'] = 1; echo 'STRING_TO_INT set OK' . PHP_EOL;" 2>&1
            Write-Host "Exit code: $LASTEXITCODE"

            Write-Host "`n--- Test 8: Judy BITSET set 10 + iterate ---"
            & $php.FullName -n -d "extension=$($ext.FullName)" -r "
              `$j = new Judy(Judy::BITSET);
              for (`$i = 0; `$i < 10; `$i++) { `$j[`$i] = true; }
              echo 'set 10 OK' . PHP_EOL;
              echo 'count=' . `$j->count() . PHP_EOL;
              echo 'size=' . `$j->size() . PHP_EOL;
              foreach (`$j as `$k => `$v) { echo `$k . ' '; }
              echo PHP_EOL . 'iterate OK' . PHP_EOL;
            " 2>&1
            Write-Host "Exit code: $LASTEXITCODE"
          } else {
            Write-Host "php.exe or php_judy.dll not found"
          }

          Write-Host "`n=== Build log (last 30 lines) ==="
          $buildLog = Get-ChildItem -Path ".\build" -Recurse -Filter "build.log" -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($buildLog) {
            Get-Content $buildLog.FullName -Tail 30
          }
